---
sidebar: sidebar 
permalink: openshift/osv-vm-dr-using-tp.html 
keywords: OpenShift, OCP, Trident, Trident protect, NetApp ONTAP, Red Hat OpenShift, OpenShift Virtualization, ROSA, Red Hat OpenShift Virtualization 
summary: Red Hat OpenShift-Virtualisierung auf ROSA 
---
= Richten Sie Failover und Failback für VMs in Red Hat OpenShift Virtualization mit Trident Protect ein
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
Richten Sie mit Trident Protect die Notfallwiederherstellung für VMs in OpenShift Virtualization ein.  Dieses Verfahren umfasst das Erstellen eines AppVault mit ONTAP S3, das Einrichten von AppMirror-Beziehungen zwischen Quell- und Disaster Recovery-Namespaces, das Planen der Replikation und das Ausführen von Failover- und Failback-Vorgängen, um die VM-Verfügbarkeit während Site-Ausfällen aufrechtzuerhalten.



== Voraussetzungen

* Trident muss installiert sein.  Backend- und Speicherklassen müssen erstellt werden, bevor OpenShift Virtualization mithilfe des OpenShift Virtualization-Operators auf dem Cluster installiert wird.
* Trident Protect muss installiert werden, um Failover- und Failback-Vorgänge für die OpenShift-VMs zu implementieren.  Beachten Sie die Anweisungen hier, umlink:https://docs.netapp.com/us-en/trident/trident-protect/trident-protect-installation.html["Installieren Sie Trident Protect"]


image:redhat-openshift-ocpv-tp-001.png["OCP-v Trident Protect im Trident-Protect-Namespace installiert"]

Eine VM muss in OpenShift Virtualization verfügbar sein.  Einzelheiten zum Bereitstellen einer neuen VM oder zum Migrieren einer vorhandenen VM in OpenShift Virtualization finden Sie im entsprechenden Abschnitt der Dokumentation.

image:redhat-openshift-ocpv-tp-003.png["OCP-v VM im Source-NS-Namespace installiert"]



== App Vault mit ONTAP S3 erstellen

In diesem Abschnitt wird gezeigt, wie Sie mithilfe des Ontap S3-Objektspeichers einen App-Tresor in Trident Protect einrichten.

Verwenden Sie OC-Befehle und die unten gezeigten YAML-Dateien, um ein Geheimnis und die benutzerdefinierte Appvault-Ressource für Ontap S3 zu erstellen.  Stellen Sie sicher, dass Sie sie im Trident Protect-Namespace erstellen.

[source, cli]
----
oc create -f app-vault-secret.yaml -n trident-protect
oc create -f app-vault.yaml -n trident-protect
----
[source, yaml]
----
apiVersion: v1
# You can provide the keys either as stringData or base 64 encoded data
stringData:
  accessKeyID: "<access key id as obtained from ONTAP>"
  secretAccessKey: "<secret access key as obtained from ONTAP>"
#data:
  #accessKeyID: <base 64 encoded value of access key>
  #secretAccessKey: <base 64 encoded value of secret access key>
kind: Secret
metadata:
  name: appvault-secret
  namespace: trident-protect
type: Opaque
----
[source, yaml]
----
apiVersion: protect.trident.netapp.io/v1
kind: AppVault
metadata:
  name: ontap-s3-appvault
  namespace: trident-protect
spec:
  providerConfig:
    azure:
      accountName: ""
      bucketName: ""
      endpoint: ""
    gcp:
      bucketName: ""
      projectID: ""
    s3:
      bucketName: trident-protect
      endpoint: <data lif to use to access S3>
      secure: "false"
      skipCertValidation: "true"
  providerCredentials:
    accessKeyID:
      valueFromSecret:
        key: accessKeyID
        name: appvault-secret
    secretAccessKey:
      valueFromSecret:
        key: secretAccessKey
        name: appvault-secret
  providerType: OntapS3
----
Stellen Sie sicher, dass der Ontap S3-Tresor erstellt wurde und sich im Status „Verfügbar“ befindet

image:redhat-openshift-ocpv-tp-002.png["OCP-v Appvault im Trident-Protect-Namespace"]



== Erstellen Sie eine Trident Protect-App für die VM

Erstellen Sie eine benutzerdefinierte App-Ressource im Namespace, in dem sich die VM befindet.

image:redhat-openshift-ocpv-tp-004.png["OCP-v-App im Source-NS-Namespace"]

[source, CLI]
----
tridentctl-protect create app source-vm -n source-ns --namespaces source-ns
----
image:redhat-openshift-ocpv-tp-004.png["OCP-v-App im Source-NS-Namespace"]



== Erstellen Sie eine Trident -Schutz-App für die Disaster Recovery-VM in einem neuen Namespace

[source, CLI]
----
oc create ns dr-ns
tridentctl-protect create app dr-vm -n dr-ns --namespaces dr-ns
----
image:redhat-openshift-ocpv-tp-005.png["OCP-v-App im Source-NS-Namespace"]



== Erstellen Sie einen AppMirror-Zeitplan im Quellnamespace

Erstellen Sie mithilfe des YAML wie gezeigt einen Zeitplan für AppMirror.  Dadurch werden Snapshots nach dem Zeitplan (alle 5 Minuten) erstellt und 2 Snapshots gespeichert

[source, CLI]
----
oc create -f appmirror-schedule.yaml -n source-ns
----
[source, yaml]
----
apiVersion: protect.trident.netapp.io/v1
kind: Schedule
metadata:
  name: appmirror-sched1
spec:
  appVaultRef: ontap-s3-appvault
  applicationRef: source-vm
  backupRetention: "0"
  enabled: true
  granularity: Custom
  recurrenceRule: |-
    DTSTART:20240901T000200Z
    RRULE:FREQ=MINUTELY;INTERVAL=5
  snapshotRetention: "2"
----
image:redhat-openshift-ocpv-tp-006.png["App-Spiegel Zeitplan source-ns Namespace"]

image:redhat-openshift-ocpv-tp-007.png["Snapshot erstellt"]



== Erstellen Sie eine AppMirror-Beziehung im DR-Namespace

Erstellen Sie eine Appmirror-Beziehung im Disaster Recovery-Namespace.  Setzen Sie den gewünschten Status auf „Etabliert“.

[source, yaml]
----
apiVersion: protect.trident.netapp.io/v1
kind: AppMirrorRelationship
metadata:
  name: amr1
spec:
  desiredState: Established
  destinationAppVaultRef: ontap-s3-appvault
  destinationApplicationRef: dr-vm
  namespaceMapping:
  - destination: dr-ns
    source: source-ns
  recurrenceRule: |-
    DTSTART:20240901T000200Z
    RRULE:FREQ=MINUTELY;INTERVAL=5
  sourceAppVaultRef: ontap-s3-appvault
  sourceApplicationName: source-vm
  sourceApplicationUID: "<application UID of the source VM>"
  storageClassName: "ontap-nas"
----

NOTE: Sie können die Anwendungs-UID der Quell-VM aus der JSON-Ausgabe der Quell-App abrufen, wie unten gezeigt

image:redhat-openshift-ocpv-tp-008.png["App-UID erstellt"]

image:redhat-openshift-ocpv-tp-009.png["App Mirror-Beziehung erstellen"]

Wenn die AppMirror-Beziehung hergestellt ist, wird der aktuellste Snapshot in den Zielnamespace übertragen.  Der PVC wird für die VM im dr-Namespace erstellt, der VM-Pod wird jedoch noch nicht im dr-Namespace erstellt.

image:redhat-openshift-ocpv-tp-010.png["App-Spiegel-Beziehung erstellen ist hergestellt"]

image:redhat-openshift-ocpv-tp-011.png["Statusänderungen für App Mirror"]

image:redhat-openshift-ocpv-tp-012.png["PVC wird im Zielnamespace erstellt"]



== Fördern Sie die Beziehung zum Failover

Ändern Sie den gewünschten Status der Beziehung in „Promoted“, um die VM im DR-Namespace zu erstellen.  Die VM wird weiterhin im Quellnamespace ausgeführt.

[source, CLI]
----
oc patch amr amr1 -n dr-ns --type=merge -p '{"spec":{"desiredState":"Promoted"}}'
----
image:redhat-openshift-ocpv-tp-013.png["Patch für AppMirror-Beziehung anwenden"]

image:redhat-openshift-ocpv-tp-014.png["AppMirror-Beziehung befindet sich im Status „Promoted“"]

image:redhat-openshift-ocpv-tp-015.png["Im DR-Namespace erstellte VM"]

image:redhat-openshift-ocpv-tp-016.png["VM in Quell-NS läuft noch"]



== Stellen Sie die Beziehung erneut zu Failback her

Ändern Sie den gewünschten Status der Beziehung in „Etabliert“.  Die VM wird im DR-Namespace gelöscht.  Das PVC ist weiterhin im DR-Namespace vorhanden.  Die VM wird weiterhin im Quellnamespace ausgeführt.  Die ursprüngliche Beziehung vom Quellnamespace zu DR ns wird hergestellt. .

[source, CLI]
----
oc patch amr amr1 -n dr-ns --type=merge -p '{"spec":{"desiredState":"Established"}}'
----
image:redhat-openshift-ocpv-tp-017.png["Patch zum etablierten Zustand"]

image:redhat-openshift-ocpv-tp-018.png["App Mirror im etablierten Zustand"]

image:redhat-openshift-ocpv-tp-019.png["PVC in DR ns bleibt weiterhin"]

image:redhat-openshift-ocpv-tp-020.png["POD und PVC in der Quelle ns bleibt weiterhin"]



== Videodemonstration

Das folgende Video zeigt eine Demonstration der Implementierung eines Disaster Recovery-Szenarios für eine OpenShift-VM mit Trident Protect

.Notfallwiederherstellung mit Trident Protect
video::ae4bdcf7-b344-4f19-89ed-b2d500f94efd[panopto,width=360]